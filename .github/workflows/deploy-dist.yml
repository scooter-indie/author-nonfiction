name: Deploy to Distribution Repo

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 0.14.2)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  deploy-dist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', inputs.version) || github.ref }}

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Create build directory
        run: mkdir -p build/temp

      - name: Copy framework files
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Copy directories
          cp -r Process build/temp/
          cp -r .claude build/temp/
          cp -r scripts build/temp/

          # Create VERSION file
          echo -n "$VERSION" > build/temp/VERSION

          # Copy root documentation files
          cp INSTALLATION.md CHANGELOG.md configure.md system-instructions.md LICENSE build/temp/

          # Use FW_ROOT template as CLAUDE.md (minimal version for v0.15.0+)
          cp Process/Templates/FW_ROOT_CLAUDE_template.md build/temp/CLAUDE.md

          # Copy migration configuration (legacy support)
          cp .nonfiction-migrations.json build/temp/ 2>/dev/null || echo "No legacy migrations file"

      - name: Remove development files
        run: |
          cd build/temp

          # Remove all _chg.md files
          find . -name "*_chg.md" -delete

          # Remove development-only files
          rm -f PREPARE_RELEASE.md
          rm -f Process/Prompts/Prompt_99_Build_Release.md

          # Remove Proposal directory (maintainer-only)
          rm -rf Proposal/

          # Remove Documentation directory (maintainer-only, v0.15.0+)
          rm -rf Documentation/

          # Remove local settings
          rm -f .claude/settings.local.json

          # Remove maintainer-only commands
          rm -f .claude/commands/gh-workflow.md

      - name: Validate dist structure
        run: |
          cd build/temp
          echo "=== Validating dist structure (v0.15.0+) ==="

          # Check VERSION file exists
          if [ ! -f "VERSION" ]; then
            echo "ERROR: VERSION file missing!"
            exit 1
          fi
          echo "VERSION: $(cat VERSION)"

          # Check CLAUDE.md is minimal (should be small)
          CLAUDE_SIZE=$(wc -c < CLAUDE.md)
          if [ "$CLAUDE_SIZE" -gt 5000 ]; then
            echo "WARNING: CLAUDE.md is larger than expected ($CLAUDE_SIZE bytes)"
            echo "Should be using minimal FW_ROOT template"
          fi

          # Check new templates exist
          REQUIRED_TEMPLATES=(
            "Process/Templates/BOOKS_ROOT_CLAUDE_template.md"
            "Process/Templates/FW_ROOT_CLAUDE_template.md"
            "Process/Templates/Archive_README_template.md"
            "Process/Templates/books-registry_template.json"
            "Process/Templates/fw-location_template.json"
            "Process/Templates/settings_template.json"
          )

          for template in "${REQUIRED_TEMPLATES[@]}"; do
            if [ ! -f "$template" ]; then
              echo "ERROR: Missing template: $template"
              exit 1
            fi
            echo "OK: $template"
          done

          # Check migrations directory
          if [ ! -d "Process/migrations" ]; then
            echo "ERROR: Process/migrations directory missing!"
            exit 1
          fi
          echo "OK: Process/migrations/"

          # Verify excluded directories are gone
          if [ -d "Documentation" ]; then
            echo "ERROR: Documentation/ should not be in dist!"
            exit 1
          fi
          if [ -d "Proposal" ]; then
            echo "ERROR: Proposal/ should not be in dist!"
            exit 1
          fi

          # Verify scripts directory exists with required files
          REQUIRED_SCRIPTS=(
            "scripts/init.sh"
            "scripts/detect-tools.sh"
            "scripts/generate-content.sh"
            "scripts/generate-usage-guide.sh"
          )

          for script in "${REQUIRED_SCRIPTS[@]}"; do
            if [ ! -f "$script" ]; then
              echo "ERROR: Missing script: $script"
              exit 1
            fi
            echo "OK: $script"
          done

          echo "=== Dist structure validation passed ==="

      - name: Create manifest template
        run: |
          cat > build/temp/Process/Templates/manifest_template.json << 'EOF'
          {
            "framework": "AI-Assisted Nonfiction Authoring",
            "frameworkVersion": "${{ steps.version.outputs.version }}",
            "installedVersion": null,
            "installedDate": null,
            "releaseDate": "$(date +%Y-%m-%d)",
            "releaseUrl": "https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}",
            "distributionRepo": "https://github.com/scooter-indie/author-nonfiction-dist",
            "sourceRepo": "https://github.com/scooter-indie/author-nonfiction"
          }
          EOF

      - name: Create dist-specific gitignore
        run: |
          cat > build/temp/.gitignore << 'GITIGNORE'
          # OS files
          .DS_Store
          Thumbs.db

          # Editor files
          .vscode/
          .idea/
          *.swp
          *.swo
          *~

          # Temporary files
          *.tmp
          *.bak

          # User-specific (not in dist repo)
          .claude/settings.local.json
          GITIGNORE

      - name: Create dist README
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cat > build/temp/README.md << 'README'
          # AI-Assisted Nonfiction Authoring Framework

          **Distribution Repository** - Clone this repo to start writing your nonfiction book with AI assistance.

          ---

          ## Quick Start (Claude Code CLI)

          **Recommended method** - Full automation with git integration.

          ```bash
          # 1. Clone the framework
          git clone https://github.com/scooter-indie/author-nonfiction-dist.git my-book
          cd my-book

          # 2. Start Claude Code
          claude

          # 3. Configure the framework (say this in Claude Code)
          execute configure.md

          # 4. Initialize your book (say this in Claude Code)
          execute Prompt 1
          ```

          After setup, start each session with:
          ```
          /fw-init
          ```

          ---

          ## Alternative: Claude Desktop

          If you prefer Claude Desktop over the CLI:

          ### Step 1: Clone and Open

          ```bash
          git clone https://github.com/scooter-indie/author-nonfiction-dist.git my-book
          ```

          ### Step 2: Configure System Instructions

          1. Open Claude Desktop
          2. Go to **Settings** ‚Üí **Custom Instructions**
          3. Open `system-instructions.md` from your cloned directory
          4. Copy everything between the `---SYSTEM INSTRUCTIONS---` markers (lines 40-356)
          5. Paste into Claude Desktop's Custom Instructions field
          6. Save and **start a new chat**

          ### Step 3: Run Configuration

          In your new Claude Desktop chat, say:
          ```
          execute configure.md
          ```

          Follow the prompts. When git commands are needed, Claude will provide commands to run in Claude Code CLI.

          ### Step 4: Initialize Your Book

          ```
          execute Prompt 1
          ```

          ---

          ## Documentation & Support

          | Resource | Link |
          |----------|------|
          | Full Documentation | [Main Repository](https://github.com/scooter-indie/author-nonfiction) |
          | Issues & Bugs | [Report Issues](https://github.com/scooter-indie/author-nonfiction/issues) |
          | Release Notes | [Releases](https://github.com/scooter-indie/author-nonfiction/releases) |
          | Installation Guide | [INSTALLATION.md](INSTALLATION.md) |

          ---

          ## Updating the Framework

          ```bash
          git pull origin main
          ```

          Then run `execute configure.md` to apply any migrations.

          ---

          README
          echo "**Version:** ${VERSION} | [Changelog](CHANGELOG.md)" >> build/temp/README.md

      - name: Deploy via PR to distribution repo
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_REPO_TOKEN }}
          GH_TOKEN: ${{ secrets.DEPLOY_REPO_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BRANCH="release-v${VERSION}"

          # Clone the dist repo
          git clone https://x-access-token:${DEPLOY_TOKEN}@github.com/scooter-indie/author-nonfiction-dist.git deploy-repo

          cd deploy-repo

          # Create release branch
          git checkout -b "${BRANCH}"

          # Remove all files except .git
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +

          # Copy release files (shopt -s dotglob makes * include hidden files)
          shopt -s dotglob
          cp -r ../build/temp/* .
          shopt -u dotglob

          # Verify dotfiles were copied
          echo "Verifying copied files:"
          ls -la
          echo "Verifying .claude directory:"
          ls -la .claude/ || echo "WARNING: .claude directory not found!"

          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Commit changes
          git add -A
          git commit -m "Release v${VERSION}

          Automated deployment from scooter-indie/author-nonfiction

          Release: https://github.com/scooter-indie/author-nonfiction/releases/tag/v${VERSION}" || echo "No changes to commit"

          # Push branch
          git push origin "${BRANCH}"

          # Create PR and auto-merge (0 approvals required)
          gh pr create \
            --repo scooter-indie/author-nonfiction-dist \
            --base main \
            --head "${BRANCH}" \
            --title "Release v${VERSION}" \
            --body "Automated deployment from [scooter-indie/author-nonfiction](https://github.com/scooter-indie/author-nonfiction/releases/tag/v${VERSION})"

          # Merge the PR immediately (branch protection allows 0 approvals)
          gh pr merge "${BRANCH}" \
            --repo scooter-indie/author-nonfiction-dist \
            --merge \
            --delete-branch

          # Create and push version tag (skip if already exists)
          git checkout main
          git pull origin main
          git tag "v${VERSION}" 2>/dev/null || echo "Tag v${VERSION} already exists, skipping"
          git push origin "v${VERSION}" 2>/dev/null || echo "Tag v${VERSION} already pushed, skipping"

      - name: Summary
        run: |
          VERSION=${{ steps.version.outputs.version }}
          echo "‚úÖ Deployed v${VERSION} to distribution repo"
          echo "üì¶ Clone: git clone https://github.com/scooter-indie/author-nonfiction-dist.git"
          echo "üè∑Ô∏è Tag: v${VERSION}"

      - name: Cleanup
        if: always()
        run: |
          rm -rf build/
          rm -rf deploy-repo/
          echo "Build directories cleaned up"

name: Deploy to Distribution Repo

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 0.14.2)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  deploy-dist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', inputs.version) || github.ref }}

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Create build directory
        run: mkdir -p build/temp

      - name: Copy framework files
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Copy directories
          cp -r Process build/temp/
          cp -r .claude build/temp/
          cp -r scripts build/temp/

          # Create VERSION file
          echo -n "$VERSION" > build/temp/VERSION

          # Copy root documentation files
          cp INSTALLATION.md CHANGELOG.md configure.md system-instructions.md LICENSE build/temp/

          # Copy bootstrap scripts to root (v0.16.0+)
          cp Process/Templates/configure.bat build/temp/
          cp Process/Templates/configure.sh build/temp/
          chmod +x build/temp/configure.sh

          # Use FW_ROOT template as CLAUDE.md (minimal version for v0.15.0+)
          cp Process/Templates/FW_ROOT_CLAUDE_template.md build/temp/CLAUDE.md

          # Copy migration configuration (legacy support)
          cp .nonfiction-migrations.json build/temp/ 2>/dev/null || echo "No legacy migrations file"

      - name: Remove development files
        run: |
          cd build/temp

          # Remove all _chg.md files
          find . -name "*_chg.md" -delete

          # Remove development-only files
          rm -f PREPARE_RELEASE.md
          rm -f Process/Prompts/Prompt_99_Build_Release.md

          # Remove Proposal directory (maintainer-only)
          rm -rf Proposal/

          # Remove Documentation directory (maintainer-only, v0.15.0+)
          rm -rf Documentation/

          # Remove local settings
          rm -f .claude/settings.local.json

          # Remove maintainer-only commands
          rm -f .claude/commands/gh-workflow.md

      - name: Validate dist structure
        run: |
          cd build/temp
          echo "=== Validating dist structure (v0.16.0+) ==="

          # Check VERSION file exists
          if [ ! -f "VERSION" ]; then
            echo "ERROR: VERSION file missing!"
            exit 1
          fi
          echo "VERSION: $(cat VERSION)"

          # Check bootstrap scripts at root
          if [ ! -f "configure.bat" ] || [ ! -f "configure.sh" ]; then
            echo "ERROR: Bootstrap scripts (configure.bat/sh) missing at root!"
            exit 1
          fi
          echo "OK: Bootstrap scripts at root"

          # Check CLAUDE.md is minimal (should be small)
          CLAUDE_SIZE=$(wc -c < CLAUDE.md)
          if [ "$CLAUDE_SIZE" -gt 5000 ]; then
            echo "WARNING: CLAUDE.md is larger than expected ($CLAUDE_SIZE bytes)"
            echo "Should be using minimal FW_ROOT template"
          fi

          # Check new templates exist
          REQUIRED_TEMPLATES=(
            "Process/Templates/FW_ROOT_CLAUDE_template.md"
            "Process/Templates/CONFIG_ROOT_CLAUDE_template.md"
            "Process/Templates/Archive_README_template.md"
            "Process/Templates/PROJECT_ROOT_gitignore_template"
            "Process/Templates/books-registry_template.json"
            "Process/Templates/fw-location_template.json"
            "Process/Templates/settings_template.json"
            "Process/Templates/start-authoring.bat"
            "Process/Templates/start-authoring.sh"
            "Process/Templates/bp-start-authoring.bat"
            "Process/Templates/bp-start-authoring.sh"
            "Process/Templates/configure.bat"
            "Process/Templates/configure.sh"
            "Process/Templates/.claude/commands/fw-init.md"
            "Process/Templates/.claude/commands/switch-book.md"
            "Process/Templates/.claude/commands/manage-book.md"
            "Process/Templates/.claude/agents/book-writing-assistant.md"
          )

          for template in "${REQUIRED_TEMPLATES[@]}"; do
            if [ ! -f "$template" ]; then
              echo "ERROR: Missing template: $template"
              exit 1
            fi
            echo "OK: $template"
          done

          # Check migrations directory
          if [ ! -d "Process/migrations" ]; then
            echo "ERROR: Process/migrations directory missing!"
            exit 1
          fi
          echo "OK: Process/migrations/"

          # Verify excluded directories are gone
          if [ -d "Documentation" ]; then
            echo "ERROR: Documentation/ should not be in dist!"
            exit 1
          fi
          if [ -d "Proposal" ]; then
            echo "ERROR: Proposal/ should not be in dist!"
            exit 1
          fi

          # Verify scripts directory exists with required files
          REQUIRED_SCRIPTS=(
            "scripts/init.sh"
            "scripts/detect-tools.sh"
            "scripts/generate-content.sh"
            "scripts/generate-usage-guide.sh"
          )

          for script in "${REQUIRED_SCRIPTS[@]}"; do
            if [ ! -f "$script" ]; then
              echo "ERROR: Missing script: $script"
              exit 1
            fi
            echo "OK: $script"
          done

          echo "=== Dist structure validation passed ==="

      - name: Create manifest template
        run: |
          cat > build/temp/Process/Templates/manifest_template.json << 'EOF'
          {
            "framework": "AI-Assisted Nonfiction Authoring",
            "frameworkVersion": "${{ steps.version.outputs.version }}",
            "installedVersion": null,
            "installedDate": null,
            "releaseDate": "$(date +%Y-%m-%d)",
            "releaseUrl": "https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}",
            "distributionRepo": "https://github.com/scooter-indie/author-nonfiction-dist",
            "sourceRepo": "https://github.com/scooter-indie/author-nonfiction"
          }
          EOF

      - name: Create dist-specific gitignore
        run: |
          cat > build/temp/.gitignore << 'GITIGNORE'
          # OS files
          .DS_Store
          Thumbs.db

          # Editor files
          .vscode/
          .idea/
          *.swp
          *.swo
          *~

          # Temporary files
          *.tmp
          *.bak

          # User-specific (not in dist repo)
          .claude/settings.local.json
          GITIGNORE

      - name: Create dist README
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cat > build/temp/README.md << 'README'
          # AI-Assisted Nonfiction Authoring Framework

          **Distribution Repository** - Clone this repo to start writing nonfiction books with AI assistance.

          ---

          ## Quick Start (v0.16.0+)

          ### 1. Clone the Framework

          ```bash
          git clone https://github.com/scooter-indie/author-nonfiction-dist.git ~/Downloads/author-nonfiction
          ```

          ### 2. Run Setup Script

          **Windows:**
          ```batch
          cd %USERPROFILE%\Downloads\author-nonfiction
          configure.bat
          ```

          **macOS/Linux:**
          ```bash
          cd ~/Downloads/author-nonfiction
          ./configure.sh
          ```

          ### 3. Follow Setup Prompts

          The setup will:
          - Ask where to create your PROJECT_ROOT (writing environment)
          - Create the unified directory structure
          - Initialize git repository
          - Chain to start-authoring automatically

          ### 4. Create Your First Book

          After setup completes, say: `Execute Prompt 1`

          ---

          ## Architecture (v0.16.0+)

          ```
          PROJECT_ROOT/
          ‚îú‚îÄ‚îÄ FW_ROOT/              # Framework (cloned, gitignored)
          ‚îú‚îÄ‚îÄ BOOKS_ROOT/           # Your books
          ‚îÇ   ‚îú‚îÄ‚îÄ [Book-Name]/
          ‚îÇ   ‚îî‚îÄ‚îÄ Archive/
          ‚îú‚îÄ‚îÄ .config/              # Configuration
          ‚îú‚îÄ‚îÄ start-authoring.*     # Startup scripts
          ‚îî‚îÄ‚îÄ .gitignore
          ```

          ---

          ## Key Features

          - üìù **16 Conversational Prompts** for writing, editing, and publishing
          - üé® **19 Writing Styles** across 5 categories (or create your own)
          - üìö **Multi-Book Support** - Work on multiple books from one framework
          - üîç **Consistency Checking** and quality control
          - üì¶ **Export to DOCX, PDF, EPUB** for publication
          - ‚ú® **Anti-Hallucination Guidelines** for factual accuracy

          ---

          ## Session Workflow

          Start sessions with the startup script:
          - **Windows:** `start-authoring.bat` from PROJECT_ROOT
          - **macOS/Linux:** `./start-authoring.sh` from PROJECT_ROOT

          Common commands:
          ```
          execute Prompt 3    # Apply changes from _chg files
          execute Prompt 4    # Interactive editing
          execute Prompt 10   # View progress dashboard
          execute Prompt 8    # Consistency check
          ```

          ---

          ## Documentation & Support

          | Resource | Link |
          |----------|------|
          | Installation Guide | [INSTALLATION.md](INSTALLATION.md) |
          | Quick Reference | `Process/Prompts/QUICK_REFERENCE.md` |
          | Full Documentation | [Main Repository](https://github.com/scooter-indie/author-nonfiction) |
          | Issues & Bugs | [Report Issues](https://github.com/scooter-indie/author-nonfiction/issues) |
          | Release Notes | [Releases](https://github.com/scooter-indie/author-nonfiction/releases) |

          ---

          ## Updating

          Framework updates are checked automatically on `/fw-init`. To update manually:

          ```bash
          cd PROJECT_ROOT/FW_ROOT
          git pull origin main
          ```

          Then run `/fw-init` to apply any migrations.

          ---

          README
          echo "**Version:** ${VERSION} | [Changelog](CHANGELOG.md)" >> build/temp/README.md

      - name: Deploy via PR to distribution repo
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_REPO_TOKEN }}
          GH_TOKEN: ${{ secrets.DEPLOY_REPO_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BRANCH="release-v${VERSION}"

          # Clone the dist repo
          git clone https://x-access-token:${DEPLOY_TOKEN}@github.com/scooter-indie/author-nonfiction-dist.git deploy-repo

          cd deploy-repo

          # Create release branch
          git checkout -b "${BRANCH}"

          # Remove all files except .git
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +

          # Copy release files (shopt -s dotglob makes * include hidden files)
          shopt -s dotglob
          cp -r ../build/temp/* .
          shopt -u dotglob

          # Verify dotfiles were copied
          echo "Verifying copied files:"
          ls -la
          echo "Verifying .claude directory:"
          ls -la .claude/ || echo "WARNING: .claude directory not found!"

          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Commit changes
          git add -A
          git commit -m "Release v${VERSION}

          Automated deployment from scooter-indie/author-nonfiction

          Release: https://github.com/scooter-indie/author-nonfiction/releases/tag/v${VERSION}" || echo "No changes to commit"

          # Push branch
          git push origin "${BRANCH}"

          # Create PR and auto-merge (0 approvals required)
          gh pr create \
            --repo scooter-indie/author-nonfiction-dist \
            --base main \
            --head "${BRANCH}" \
            --title "Release v${VERSION}" \
            --body "Automated deployment from [scooter-indie/author-nonfiction](https://github.com/scooter-indie/author-nonfiction/releases/tag/v${VERSION})"

          # Merge the PR immediately (branch protection allows 0 approvals)
          gh pr merge "${BRANCH}" \
            --repo scooter-indie/author-nonfiction-dist \
            --merge \
            --delete-branch

          # Create and push version tag (skip if already exists)
          git checkout main
          git pull origin main
          git tag "v${VERSION}" 2>/dev/null || echo "Tag v${VERSION} already exists, skipping"
          git push origin "v${VERSION}" 2>/dev/null || echo "Tag v${VERSION} already pushed, skipping"

      - name: Summary
        run: |
          VERSION=${{ steps.version.outputs.version }}
          echo "‚úÖ Deployed v${VERSION} to distribution repo"
          echo "üì¶ Clone: git clone https://github.com/scooter-indie/author-nonfiction-dist.git"
          echo "üè∑Ô∏è Tag: v${VERSION}"

      - name: Cleanup
        if: always()
        run: |
          rm -rf build/
          rm -rf deploy-repo/
          echo "Build directories cleaned up"

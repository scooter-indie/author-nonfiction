name: Release Framework

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v0.14.2
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.14.2)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Verify version matches files
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Check VERSION file (v0.15.0+)
          if [ -f "VERSION" ]; then
            VERSION_FILE=$(cat VERSION | tr -d '\n')
            echo "VERSION file: $VERSION_FILE"
            if [ "$VERSION" != "$VERSION_FILE" ]; then
              echo "ERROR: VERSION file mismatch!"
              echo "Tag version ($VERSION) doesn't match VERSION file ($VERSION_FILE)"
              exit 1
            fi
          else
            echo "WARNING: VERSION file not found - creating it"
            echo -n "$VERSION" > VERSION
          fi

          # Check Documentation file (legacy check)
          FILE_VERSION=$(grep -m 1 "^\*\*Version:\*\*" Documentation/AI-Assisted_Nonfiction_Authoring_Process.md | sed 's/.*Version:\*\* //')
          echo "Tag version: $VERSION"
          echo "Doc file version: $FILE_VERSION"
          if [ "$VERSION" != "$FILE_VERSION" ]; then
            echo "ERROR: Version mismatch!"
            echo "Git tag version ($VERSION) doesn't match file version ($FILE_VERSION)"
            echo "Please update Documentation/AI-Assisted_Nonfiction_Authoring_Process.md first"
            exit 1
          fi

          echo "All version checks passed!"

      - name: Generate release notes
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Extract version section from CHANGELOG.md
          echo "Extracting release notes for v$VERSION..."

          # Get the section between [VERSION] and the next [
          sed -n "/## \[$VERSION\]/,/^## \[/p" CHANGELOG.md | sed '$ d' > release-notes-temp.md

          # Add installation instructions (clone only)
          cat >> release-notes-temp.md <<'EOF'

---

## ðŸ“¥ Installation

```bash
# Clone the framework
git clone https://github.com/scooter-indie/author-nonfiction-dist.git my-book
cd my-book

# Start Claude Code
claude

# Configure the framework (say this in Claude Code)
execute configure.md

# Initialize your book (say this in Claude Code)
execute Prompt 1
```

**Benefits:** Easy updates via `git pull`, no extraction errors, version control built-in.

### Updating the Framework

```bash
git pull origin main
```

Then run `execute configure.md` to apply any migrations.

---

**ðŸ“– See [INSTALLATION.md](https://github.com/scooter-indie/author-nonfiction-dist/blob/main/INSTALLATION.md) for detailed instructions.**

EOF

          # Add support links
          echo "" >> release-notes-temp.md
          echo "---" >> release-notes-temp.md
          echo "" >> release-notes-temp.md
          echo "**Clone:** \`git clone https://github.com/scooter-indie/author-nonfiction-dist.git\`" >> release-notes-temp.md
          echo "**Support:** https://github.com/${{ github.repository }}/issues" >> release-notes-temp.md

          echo "Release notes generated:"
          cat release-notes-temp.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Nonfiction Framework v${{ steps.version.outputs.version }}
          body_path: release-notes-temp.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release complete
        run: |
          echo "âœ… Release v${{ steps.version.outputs.version }} published successfully!"
          echo "ðŸ“¦ Clone: git clone https://github.com/scooter-indie/author-nonfiction-dist.git"
          echo "ðŸ”„ deploy-dist.yml will automatically deploy to distribution repo"
